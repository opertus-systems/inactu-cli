name: Release Skill

on:
  workflow_dispatch:
    inputs:
      oci_ref:
        description: OCI reference to publish (for example ghcr.io/org/skill:0.1.0)
        required: true
        type: string

jobs:
  release-skill:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write
    env:
      OCI_REF: ${{ inputs.oci_ref }}
      COSIGN_YES: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Run conformance
        run: cargo conformance

      - name: Run inactu-cli tests
        run: cargo test -p inactu-cli

      - name: Prepare demo bundle artifact
        run: |
          mkdir -p dist
          cp test-vectors/good/pack-sign-roundtrip/skill.wasm dist/skill.wasm
          cp test-vectors/good/pack-sign-roundtrip/manifest.json dist/manifest.json
          cp test-vectors/good/pack-sign-roundtrip/signatures.json dist/signatures.json

      - name: Install ORAS
        uses: oras-project/setup-oras@v1

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@v0.2.4

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.8.2

      - name: Generate SPDX SBOM
        run: syft dir:./dist -o spdx-json > dist/sbom.spdx.json

      - name: Vulnerability gate
        run: trivy fs --exit-code 1 --severity HIGH,CRITICAL ./dist

      - name: Log in to GHCR
        run: echo "${{ github.token }}" | oras login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Push OCI artifact
        run: |
          oras push "$OCI_REF" \
            --artifact-type application/vnd.inactu.bundle.v1 \
            dist/skill.wasm:application/wasm \
            dist/manifest.json:application/json \
            dist/signatures.json:application/json

      - name: Attach SBOM
        run: oras attach "$OCI_REF" --artifact-type application/spdx+json dist/sbom.spdx.json

      - name: Sign OCI artifact
        run: cosign sign "$OCI_REF"

      - name: Verify OCI artifact signature
        run: cosign verify "$OCI_REF"
